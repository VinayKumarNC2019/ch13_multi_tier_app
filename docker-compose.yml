# Docker Compose file reference: https://docs.docker.com/compose/compose-file/
version: '3'

services:

  postgres:
      image: postgres:9.6.6
      ports:
          - "5432" # random available host port will be chosen, same as -P
      volumes:
             - db-data:/var/lib/postgresql/data
      environment:
          POSTGRES_USER: 'exercise'
          POSTGRES_PASSWORD: 'mypass27'
          POSTGRES_DB: 'exercise'

  api:
      image: ${IMAGE_REPOSITORY:-dockerinaction/ch13_multi_tier_app}:api
      #build:
      #  context: .
      #  dockerfile: api/Dockerfile
      ports:
          - "8080:80"
      environment:
        POSTGRES_HOST: 'postgres'
        POSTGRES_PORT: '5432'
        POSTGRES_USER: 'exercise'
        POSTGRES_PASSWORD: 'mypass27'
        POSTGRES_DB: 'exercise'
        POSTGRES_SSLMODE: 'disable'
      depends_on:
        - postgres
      deploy:
          replicas: 2
          update_config:
              parallelism: 1
              delay: 5s
          restart_policy:
              condition: on-failure

  shell:
      image: alpine:3.6
      command: sleep 3600

volumes:
  db-data:
